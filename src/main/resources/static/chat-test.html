<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>실시간 채팅 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        input[type="text"], input[type="email"] {
            padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            padding: 8px 15px; background-color: #007bff; color: white;
            border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #messages {
            height: 350px; border: 1px solid #ccc; overflow-y: scroll;
            padding: 10px; margin: 10px 0; background-color: #f9f9f9; border-radius: 4px;
        }
        .message { margin-bottom: 8px; padding: 5px; }
        .system-message { color: #666; font-style: italic; text-align: center; }
        .user-message { color: #333; }
        .timestamp { color: #888; font-size: 0.9em; float: right; }
    </style>
</head>
<body>
<h1>JWT 인증 실시간 채팅 테스트</h1>

<div class="section">
    <h3>1단계: 로그인</h3>
    <input type="email" id="email" placeholder="이메일" value="user1@example.com" style="width: 200px;">
    <button onclick="login()">로그인</button>
    <div id="loginStatus" style="margin-top: 5px;"></div>
</div>

<div class="section">
    <h3>2단계: 채팅방 설정</h3>
    <input type="text" id="roomId" placeholder="채팅방 ID (UUID)" style="width: 300px;">
    <button onclick="createTestRoom()" id="createTestRoomBtn" disabled>테스트 방 생성</button>
    <button onclick="joinRoom()" id="joinRoomBtn" disabled>방 참여</button>
    <div id="roomStatus" style="margin-top: 5px;"></div>
</div>

<div class="section">
    <h3>3단계: WebSocket 연결</h3>
    <button onclick="connect()" id="connectBtn" disabled>WebSocket 연결</button>
    <button onclick="disconnect()" id="disconnectBtn" disabled>연결 해제</button>
    <button onclick="loadMessages()" id="loadMessagesBtn" disabled>메시지 불러오기</button>
    <div id="connectStatus" style="margin-top: 5px;"></div>
</div>

<div id="messages">
    <div style="color: #666; text-align: center; padding: 20px;">
        <em>메시지가 여기에 표시됩니다</em>
    </div>
</div>

<div>
    <input type="text" id="messageInput" placeholder="메시지 입력..." style="width: calc(100% - 100px);" disabled>
    <button onclick="sendMessage()" id="sendBtn" style="width: 90px;" disabled>전송</button>
</div>

<script>
    let stompClient = null;
    let jwtToken = null;
    let currentRoomId = null;

    function login() {
        const email = document.getElementById('email').value;

        fetch('http://localhost:8080/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(response => {
            if (!response.ok) throw new Error('로그인 실패');
            return response.json();
        })
        .then(data => {
            jwtToken = data.accessToken;
            document.getElementById('loginStatus').innerHTML =
                '<span style="color: green;">로그인 성공!</span>';
            document.getElementById('createTestRoomBtn').disabled = false;
            document.getElementById('joinRoomBtn').disabled = false;
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('loadMessagesBtn').disabled = false;
        })
        .catch(error => {
            document.getElementById('loginStatus').innerHTML =
                '<span style="color: red;"> ' + error + '</span>';
        });
    }

    async function createTestRoom() {
        if (!jwtToken) {
            alert('먼저 로그인하세요');
            return;
        }

        try {
            // 1. 실제 존재하는 게시글 ID를 가져옴
            console.log('게시글 목록을 조회 중...');
            const postsResponse = await fetch('http://localhost:8080/community/posts');

            if (!postsResponse.ok) {
                throw new Error(`게시글 목록 조회 실패: HTTP ${postsResponse.status}`);
            }

            const posts = await postsResponse.json();
            console.log('조회된 게시글들:', posts);

            if (!posts || posts.length === 0) {
                alert('채팅방을 생성할 수 있는 게시글이 없습니다. 먼저 커뮤니티에 게시글을 작성해주세요.');
                return;
            }

            // 2. 첫 번째 게시글의 ID를 사용
            const actualSubjectId = posts[0].id;
            console.log('사용할 게시글 ID:', actualSubjectId);

            const requestData = {
                type: 'COMMUNITY',
                subjectId: actualSubjectId, // 실제 존재하는 게시글 ID 사용
                title: '테스트 채팅방',
                maxMembers: 4
            };

            console.log('서버로 보내는 데이터:', requestData);

            // 3. 채팅방 생성 요청
            const response = await fetch('http://localhost:8080/chat/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify(requestData)
            });

            const responseText = await response.text();
            console.log('서버 응답:', responseText);

            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = JSON.parse(responseText);
                    errorMessage = `${errorData.message} (코드: ${errorData.code})`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${responseText}`;
                }
                throw new Error(errorMessage);
            }

            const data = JSON.parse(responseText);
            currentRoomId = data.id;
            document.getElementById('roomId').value = currentRoomId;
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: green;">✅ 방 생성 성공! ID: ' + currentRoomId + '</span>';

        } catch (error) {
            console.error('상세 오류 정보:', error);
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: red;">❌ ' + error.message + '</span>';
        }
    }

    function joinRoom() {
        if (!jwtToken) {
            alert('먼저 로그인하세요');
            return;
        }

        const roomId = document.getElementById('roomId').value;
        if (!roomId) {
            alert('채팅방 ID를 입력하세요');
            return;
        }

        fetch('http://localhost:8080/chat/rooms/' + roomId + '/join', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + jwtToken }
        })
        .then(response => {
            if (!response.ok) throw new Error('방 참여 실패');
            currentRoomId = roomId;
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: green;"> 방 참여 성공!</span>';
        })
        .catch(error => {
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: red;">❌ ' + error + '</span>';
        });
    }

    function connect() {
        if (!jwtToken) {
            alert('먼저 로그인하세요');
            return;
        }

        currentRoomId = document.getElementById('roomId').value;
        if (!currentRoomId) {
            alert('채팅방 ID를 입력하세요');
            return;
        }

        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.onStompError = function (frame) {
            console.error(' STOMP 브로커 오류:', frame.headers['message']);
            console.error(' 오류 상세:', frame.body);
            document.getElementById('connectStatus').innerHTML =
                '<span style="color: red;"> STOMP 오류: ' + (frame.headers['message'] || '알 수 없는 오류') + '</span>';
        };

        const headers = { 'Authorization': 'Bearer ' + jwtToken };

        stompClient.connect(headers, function (frame) {
            document.getElementById('connectStatus').innerHTML =
                '<span style="color: green;"> WebSocket 연결 성공!</span>';

            // UI 업데이트
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            // 채팅방 구독
            stompClient.subscribe('/topic/rooms/' + currentRoomId, function (message) {
                console.log('🔥 서버로부터 메시지 수신:', message.body);
                try {
                    const chatMessage = JSON.parse(message.body);
                    console.log('🔥 파싱된 메시지 객체:', chatMessage);
                    displayMessage(chatMessage);
                } catch (error) {
                    console.error('❌ 메시지 파싱 오류:', error);
                    console.error('❌ 원본 메시지:', message.body);
                }
            });

            // 기존 메시지 로드
            loadMessages();

        }, function (error) {
            document.getElementById('connectStatus').innerHTML =
                '<span style="color: red;"> WebSocket 연결 실패: ' + error + '</span>';
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(function() {
                document.getElementById('connectStatus').innerHTML =
                    '<span style="color: orange;">🔌 연결 해제됨</span>';

                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            });
        }
    }

    function sendMessage() {
        const messageContent = document.getElementById('messageInput').value.trim();

        if(!messageContent){
            alert("메시지를 입력하세요");
            return;
        }

        if(!stompClient || !stompClient.connected){
            alert("WebSocket이 연결되지 않았습니다");
            return;
        }

        //  핵심 수정: 서버가 필요로 하는 완전한 메시지 객체
        const message = {
            content: messageContent,
            roomId: currentRoomId,        // 방 ID 추가
            type: 'CHAT'                  // 메시지 타입 추가
        };

        console.log(' 메시지 전송 시도:', message); // 디버깅용

        try {
            stompClient.send(
                "/app/rooms/" + currentRoomId + "/messages",
                {
                    'content-type': 'application/json',  // 필수 헤더 추가
                    'Authorization': 'Bearer ' + jwtToken  // 서버에서 STOMP 인증 필요시만 추가
                },
                JSON.stringify(message)
            );

            document.getElementById('messageInput').value = '';
            console.log(' 메시지 전송 완료');

        } catch (error) {
            console.error('메시지 전송 오류:', error);
            alert('메시지 전송 실패: ' + error.message);
        }
    }

    function loadMessages() {
        if (!jwtToken || !currentRoomId) return;

        fetch('http://localhost:8080/chat/rooms/' + currentRoomId + '/messages', {
            headers: { 'Authorization': 'Bearer ' + jwtToken }
        })
        .then(response => {
            if (!response.ok) throw new Error('메시지 로드 실패');
            return response.json();
        })
        .then(messages => {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            messages.forEach(msg => displayMessage(msg));
        })
        .catch(error => {
            console.error('메시지 로드 실패:', error);
        });
    }

    function displayMessage(message) {

        console.log('메시지 표시 시도: ', message);

        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';

        // 안전한 타임스탬프 처리
        let timestamp = '';
        try {
            if (message.createdAt) {
                timestamp = new Date(message.createdAt).toLocaleTimeString();
            } else if (message.timestamp) {
                timestamp = new Date(message.timestamp).toLocaleTimeString();
            } else {
                timestamp = new Date().toLocaleTimeString();
            }
        } catch (e) {
            timestamp = new Date().toLocaleTimeString();
        }

        if (message.type === 'SYSTEM') {
            messageElement.className += ' system-message';
            messageElement.innerHTML =
                message.content +
                ' <span class="timestamp">' + timestamp + '</span>';
        } else {
            messageElement.className += ' user-message';
            messageElement.innerHTML =
                '<strong>' + (message.senderName || '익명') + '</strong>: ' +
                message.content +
                ' <span class="timestamp">' + timestamp + '</span>';
        }

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        console.log('메시지 화면 표시 완료');
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Enter 키로 메시지 전송
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>
