<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        input[type="text"], input[type="email"] {
            padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px;
        }
        button {
            padding: 8px 15px; background-color: #007bff; color: white;
            border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;
        }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        #messages {
            height: 350px; border: 1px solid #ccc; overflow-y: scroll;
            padding: 10px; margin: 10px 0; background-color: #f9f9f9; border-radius: 4px;
        }
        .message { margin-bottom: 8px; padding: 5px; }
        .system-message { color: #666; font-style: italic; text-align: center; }
        .user-message { color: #333; }
        .timestamp { color: #888; font-size: 0.9em; float: right; }
    </style>
</head>
<body>
<h1>JWT ì¸ì¦ ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>

<div class="section">
    <h3>1ë‹¨ê³„: ë¡œê·¸ì¸</h3>
    <input type="email" id="email" placeholder="ì´ë©”ì¼" value="user1@example.com" style="width: 200px;">
    <button onclick="login()">ë¡œê·¸ì¸</button>
    <div id="loginStatus" style="margin-top: 5px;"></div>
</div>

<div class="section">
    <h3>2ë‹¨ê³„: ì±„íŒ…ë°© ì„¤ì •</h3>
    <input type="text" id="roomId" placeholder="ì±„íŒ…ë°© ID (UUID)" style="width: 300px;">
    <button onclick="createTestRoom()" id="createTestRoomBtn" disabled>í…ŒìŠ¤íŠ¸ ë°© ìƒì„±</button>
    <button onclick="joinRoom()" id="joinRoomBtn" disabled>ë°© ì°¸ì—¬</button>
    <div id="roomStatus" style="margin-top: 5px;"></div>
</div>

<div class="section">
    <h3>3ë‹¨ê³„: WebSocket ì—°ê²°</h3>
    <button onclick="connect()" id="connectBtn" disabled>WebSocket ì—°ê²°</button>
    <button onclick="disconnect()" id="disconnectBtn" disabled>ì—°ê²° í•´ì œ</button>
    <button onclick="loadMessages()" id="loadMessagesBtn" disabled>ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="connectStatus" style="margin-top: 5px;"></div>
</div>

<div id="messages">
    <div style="color: #666; text-align: center; padding: 20px;">
        <em>ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</em>
    </div>
</div>

<div>
    <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="width: calc(100% - 100px);" disabled>
    <button onclick="sendMessage()" id="sendBtn" style="width: 90px;" disabled>ì „ì†¡</button>
</div>

<script>
    let stompClient = null;
    let jwtToken = null;
    let currentRoomId = null;

    function login() {
        const email = document.getElementById('email').value;

        fetch('http://localhost:8080/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: email })
        })
        .then(response => {
            if (!response.ok) throw new Error('ë¡œê·¸ì¸ ì‹¤íŒ¨');
            return response.json();
        })
        .then(data => {
            jwtToken = data.accessToken;
            document.getElementById('loginStatus').innerHTML =
                '<span style="color: green;">ë¡œê·¸ì¸ ì„±ê³µ!</span>';
            document.getElementById('createTestRoomBtn').disabled = false;
            document.getElementById('joinRoomBtn').disabled = false;
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('loadMessagesBtn').disabled = false;
        })
        .catch(error => {
            document.getElementById('loginStatus').innerHTML =
                '<span style="color: red;"> ' + error + '</span>';
        });
    }

    async function createTestRoom() {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
            return;
        }

        try {
            // 1. ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê²Œì‹œê¸€ IDë¥¼ ê°€ì ¸ì˜´
            console.log('ê²Œì‹œê¸€ ëª©ë¡ì„ ì¡°íšŒ ì¤‘...');
            const postsResponse = await fetch('http://localhost:8080/community/posts');

            if (!postsResponse.ok) {
                throw new Error(`ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨: HTTP ${postsResponse.status}`);
            }

            const posts = await postsResponse.json();
            console.log('ì¡°íšŒëœ ê²Œì‹œê¸€ë“¤:', posts);

            if (!posts || posts.length === 0) {
                alert('ì±„íŒ…ë°©ì„ ìƒì„±í•  ìˆ˜ ìˆëŠ” ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ì»¤ë®¤ë‹ˆí‹°ì— ê²Œì‹œê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            // 2. ì²« ë²ˆì§¸ ê²Œì‹œê¸€ì˜ IDë¥¼ ì‚¬ìš©
            const actualSubjectId = posts[0].id;
            console.log('ì‚¬ìš©í•  ê²Œì‹œê¸€ ID:', actualSubjectId);

            const requestData = {
                type: 'COMMUNITY',
                subjectId: actualSubjectId, // ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê²Œì‹œê¸€ ID ì‚¬ìš©
                title: 'í…ŒìŠ¤íŠ¸ ì±„íŒ…ë°©',
                maxMembers: 4
            };

            console.log('ì„œë²„ë¡œ ë³´ë‚´ëŠ” ë°ì´í„°:', requestData);

            // 3. ì±„íŒ…ë°© ìƒì„± ìš”ì²­
            const response = await fetch('http://localhost:8080/chat/rooms', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify(requestData)
            });

            const responseText = await response.text();
            console.log('ì„œë²„ ì‘ë‹µ:', responseText);

            if (!response.ok) {
                let errorMessage = `HTTP ${response.status}`;
                try {
                    const errorData = JSON.parse(responseText);
                    errorMessage = `${errorData.message} (ì½”ë“œ: ${errorData.code})`;
                } catch (e) {
                    errorMessage = `HTTP ${response.status}: ${responseText}`;
                }
                throw new Error(errorMessage);
            }

            const data = JSON.parse(responseText);
            currentRoomId = data.id;
            document.getElementById('roomId').value = currentRoomId;
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: green;">âœ… ë°© ìƒì„± ì„±ê³µ! ID: ' + currentRoomId + '</span>';

        } catch (error) {
            console.error('ìƒì„¸ ì˜¤ë¥˜ ì •ë³´:', error);
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: red;">âŒ ' + error.message + '</span>';
        }
    }

    function joinRoom() {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
            return;
        }

        const roomId = document.getElementById('roomId').value;
        if (!roomId) {
            alert('ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        fetch('http://localhost:8080/chat/rooms/' + roomId + '/join', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + jwtToken }
        })
        .then(response => {
            if (!response.ok) throw new Error('ë°© ì°¸ì—¬ ì‹¤íŒ¨');
            currentRoomId = roomId;
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: green;"> ë°© ì°¸ì—¬ ì„±ê³µ!</span>';
        })
        .catch(error => {
            document.getElementById('roomStatus').innerHTML =
                '<span style="color: red;">âŒ ' + error + '</span>';
        });
    }

    function connect() {
        if (!jwtToken) {
            alert('ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”');
            return;
        }

        currentRoomId = document.getElementById('roomId').value;
        if (!currentRoomId) {
            alert('ì±„íŒ…ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.onStompError = function (frame) {
            console.error(' STOMP ë¸Œë¡œì»¤ ì˜¤ë¥˜:', frame.headers['message']);
            console.error(' ì˜¤ë¥˜ ìƒì„¸:', frame.body);
            document.getElementById('connectStatus').innerHTML =
                '<span style="color: red;"> STOMP ì˜¤ë¥˜: ' + (frame.headers['message'] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜') + '</span>';
        };

        const headers = { 'Authorization': 'Bearer ' + jwtToken };

        stompClient.connect(headers, function (frame) {
            document.getElementById('connectStatus').innerHTML =
                '<span style="color: green;"> WebSocket ì—°ê²° ì„±ê³µ!</span>';

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            // ì±„íŒ…ë°© êµ¬ë…
            stompClient.subscribe('/topic/rooms/' + currentRoomId, function (message) {
                console.log('ğŸ”¥ ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ :', message.body);
                try {
                    const chatMessage = JSON.parse(message.body);
                    console.log('ğŸ”¥ íŒŒì‹±ëœ ë©”ì‹œì§€ ê°ì²´:', chatMessage);
                    displayMessage(chatMessage);
                } catch (error) {
                    console.error('âŒ ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
                    console.error('âŒ ì›ë³¸ ë©”ì‹œì§€:', message.body);
                }
            });

            // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
            loadMessages();

        }, function (error) {
            document.getElementById('connectStatus').innerHTML =
                '<span style="color: red;"> WebSocket ì—°ê²° ì‹¤íŒ¨: ' + error + '</span>';
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect(function() {
                document.getElementById('connectStatus').innerHTML =
                    '<span style="color: orange;">ğŸ”Œ ì—°ê²° í•´ì œë¨</span>';

                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('messageInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            });
        }
    }

    function sendMessage() {
        const messageContent = document.getElementById('messageInput').value.trim();

        if(!messageContent){
            alert("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            return;
        }

        if(!stompClient || !stompClient.connected){
            alert("WebSocketì´ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤");
            return;
        }

        //  í•µì‹¬ ìˆ˜ì •: ì„œë²„ê°€ í•„ìš”ë¡œ í•˜ëŠ” ì™„ì „í•œ ë©”ì‹œì§€ ê°ì²´
        const message = {
            content: messageContent,
            roomId: currentRoomId,        // ë°© ID ì¶”ê°€
            type: 'CHAT'                  // ë©”ì‹œì§€ íƒ€ì… ì¶”ê°€
        };

        console.log(' ë©”ì‹œì§€ ì „ì†¡ ì‹œë„:', message); // ë””ë²„ê¹…ìš©

        try {
            stompClient.send(
                "/app/rooms/" + currentRoomId + "/messages",
                {
                    'content-type': 'application/json',  // í•„ìˆ˜ í—¤ë” ì¶”ê°€
                    'Authorization': 'Bearer ' + jwtToken  // ì„œë²„ì—ì„œ STOMP ì¸ì¦ í•„ìš”ì‹œë§Œ ì¶”ê°€
                },
                JSON.stringify(message)
            );

            document.getElementById('messageInput').value = '';
            console.log(' ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ');

        } catch (error) {
            console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
            alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
        }
    }

    function loadMessages() {
        if (!jwtToken || !currentRoomId) return;

        fetch('http://localhost:8080/chat/rooms/' + currentRoomId + '/messages', {
            headers: { 'Authorization': 'Bearer ' + jwtToken }
        })
        .then(response => {
            if (!response.ok) throw new Error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨');
            return response.json();
        })
        .then(messages => {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = '';
            messages.forEach(msg => displayMessage(msg));
        })
        .catch(error => {
            console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
        });
    }

    function displayMessage(message) {

        console.log('ë©”ì‹œì§€ í‘œì‹œ ì‹œë„: ', message);

        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';

        // ì•ˆì „í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì²˜ë¦¬
        let timestamp = '';
        try {
            if (message.createdAt) {
                timestamp = new Date(message.createdAt).toLocaleTimeString();
            } else if (message.timestamp) {
                timestamp = new Date(message.timestamp).toLocaleTimeString();
            } else {
                timestamp = new Date().toLocaleTimeString();
            }
        } catch (e) {
            timestamp = new Date().toLocaleTimeString();
        }

        if (message.type === 'SYSTEM') {
            messageElement.className += ' system-message';
            messageElement.innerHTML =
                message.content +
                ' <span class="timestamp">' + timestamp + '</span>';
        } else {
            messageElement.className += ' user-message';
            messageElement.innerHTML =
                '<strong>' + (message.senderName || 'ìµëª…') + '</strong>: ' +
                message.content +
                ' <span class="timestamp">' + timestamp + '</span>';
        }

        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        console.log('ë©”ì‹œì§€ í™”ë©´ í‘œì‹œ ì™„ë£Œ');
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    // Enter í‚¤ë¡œ ë©”ì‹œì§€ ì „ì†¡
    document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
</script>
</body>
</html>
